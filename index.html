<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Footage Offloader</title>
<style>
  :root {
    --bg: #0c0c14; --surface: #12121e; --surface2: #1a1a2a;
    --border: #ffffff0d; --border2: #1e1e30;
    --text: #e2e8f0; --text2: #94a3b8; --text3: #4a5568;
    --accent: #6d28d9; --accent2: #818cf8; --accent-light: #a78bfa;
    --green: #22c55e; --red: #ef4444; --orange: #f59e0b;
    --radius: 10px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100vh; min-height: 100dvh; overflow-x: hidden;
  }
  .app { max-width: 640px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }

  /* Header */
  .header { display: flex; justify-content: space-between; align-items: center; padding: 12px 0 20px; }
  .header h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
  .header-sub { font-size: 11px; color: var(--text3); margin-top: 2px; font-family: monospace; }
  .btn-icon {
    width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border2);
    background: var(--surface); color: var(--text2); font-size: 18px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
  }

  /* Cards */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; margin-bottom: 10px; }
  .card-label { font-size: 9px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; color: var(--text3); margin-bottom: 8px; }

  /* Status dots */
  .dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
  .dot-g { background: var(--green); box-shadow: 0 0 6px #22c55e80; }
  .dot-r { background: var(--red); }
  .dot-o { background: var(--orange); box-shadow: 0 0 6px #f59e0b80; }
  .status-row { display: flex; align-items: center; gap: 8px; font-size: 13px; }
  .status-detail { font-size: 10px; color: var(--text3); margin-top: 3px; font-family: monospace; }

  /* Path display */
  .path-display {
    background: var(--bg); border: 1px solid var(--border2); border-radius: 6px;
    padding: 7px 10px; font-family: monospace; font-size: 11px; color: var(--accent2);
    word-break: break-all; margin-bottom: 8px;
  }

  /* Fields */
  .field { margin-bottom: 8px; }
  .field label { display: block; font-size: 10px; font-weight: 600; color: var(--text3); margin-bottom: 3px; letter-spacing: 0.3px; }
  .field input, .field select {
    width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border2);
    background: var(--bg); color: var(--text); font-size: 13px; font-family: monospace; outline: none;
  }
  .field input:focus { border-color: var(--accent); }
  .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

  /* Toggles */
  .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
  .toggle-row span { font-size: 12px; color: var(--text2); }
  .toggle { position: relative; width: 42px; height: 22px; cursor: pointer; }
  .toggle input { display: none; }
  .toggle .sl {
    position: absolute; inset: 0; background: var(--surface2); border-radius: 11px;
    border: 1px solid var(--border2); transition: background .2s;
  }
  .toggle .sl::before {
    content: ''; position: absolute; width: 16px; height: 16px; border-radius: 50%;
    background: var(--text3); top: 2px; left: 2px; transition: transform .2s, background .2s;
  }
  .toggle input:checked + .sl { background: var(--accent); border-color: var(--accent); }
  .toggle input:checked + .sl::before { transform: translateX(20px); background: #fff; }

  /* Buttons */
  .btn {
    padding: 8px 16px; border-radius: 7px; border: none; font-size: 12px;
    font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;
  }
  .btn:active { transform: scale(0.97); }
  .btn-p { background: var(--accent); color: #fff; }
  .btn-s { background: var(--surface2); color: var(--text2); border: 1px solid var(--border2); }
  .btn-d { background: #ef444418; color: var(--red); border: 1px solid #ef444430; }
  .btn-sm { padding: 6px 12px; font-size: 11px; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-row { display: flex; gap: 6px; margin-top: 8px; }

  /* Reconnect banner */
  .reconnect-banner {
    background: #f59e0b10; border: 1px solid #f59e0b30; border-radius: 8px;
    padding: 10px 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;
  }
  .reconnect-banner .rb-text { font-size: 11px; color: #fbbf24; font-weight: 600; }
  .reconnect-banner .rb-sub { font-size: 10px; color: #92702c; margin-top: 2px; }

  /* File list */
  .file-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .file-count { font-size: 11px; color: var(--text3); }
  .file-list { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; max-height: 50vh; overflow-y: auto; }
  .file-item {
    display: flex; align-items: center; gap: 8px; padding: 8px 10px;
    border-bottom: 1px solid #14141f; cursor: pointer; -webkit-tap-highlight-color: transparent;
  }
  .file-item:last-child { border-bottom: none; }
  .file-item.active { background: #6d28d908; }
  .chk {
    width: 16px; height: 16px; border-radius: 4px; flex-shrink: 0;
    border: 1.5px solid var(--border2); display: flex; align-items: center;
    justify-content: center; font-size: 9px; color: transparent; transition: all .12s;
  }
  .chk.on { background: var(--accent); border-color: var(--accent); color: #fff; }
  .file-name { flex: 1; font-size: 12px; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; }
  .file-size { font-size: 10px; color: var(--text3); font-family: monospace; flex-shrink: 0; }
  .file-ext {
    font-size: 8px; font-weight: 700; padding: 1px 5px; border-radius: 3px;
    font-family: monospace; flex-shrink: 0;
  }
  .file-prog { width: 100%; height: 2px; background: var(--surface2); border-radius: 1px; margin-top: 4px; overflow: hidden; }
  .file-prog-bar { height: 100%; background: var(--accent); border-radius: 1px; transition: width .3s; }

  /* Transfer progress */
  .xfer-big { text-align: center; margin-bottom: 10px; }
  .xfer-pct { font-size: 36px; font-weight: 800; font-family: monospace; letter-spacing: -2px; }
  .xfer-sub { font-size: 11px; color: var(--text3); margin-top: 2px; }
  .prog-bg { width: 100%; height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; margin: 10px 0; }
  .prog-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--accent), var(--accent-light)); box-shadow: 0 0 10px #6d28d940; transition: width .3s; }
  .prog-meta { display: flex; justify-content: space-between; font-size: 10px; font-family: monospace; }
  .prog-meta .speed { color: var(--text3); }
  .prog-meta .eta { color: var(--accent2); }
  .xfer-label { font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; padding: 4px 10px; border-radius: 5px; }
  .xfer-active { background: #f59e0b18; border: 1px solid #f59e0b30; color: var(--orange); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
  .pulse { animation: pulse 2s infinite; }

  /* Queue list in transfer view */
  .queue-item { display: flex; align-items: center; gap: 6px; padding: 3px 0; font-size: 10px; font-family: monospace; }
  .queue-done { opacity: 0.35; color: var(--text3); }
  .queue-cur { color: var(--accent-light); }
  .queue-pend { color: var(--text3); }

  /* Bottom bar */
  .bottom-bar {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: var(--surface); border-top: 1px solid var(--border2);
    padding: 10px 16px; padding-bottom: max(10px, env(safe-area-inset-bottom));
    display: flex; align-items: center; justify-content: space-between; z-index: 100;
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  }
  .bottom-info { font-size: 12px; color: var(--text2); }
  .bottom-info small { display: block; font-size: 10px; color: var(--text3); }

  /* Settings overlay */
  .overlay { display: none; position: fixed; inset: 0; background: #00000080; z-index: 150; }
  .overlay.open { display: flex; align-items: flex-end; justify-content: center; }
  .settings-panel {
    background: var(--surface); border-radius: 20px 20px 0 0; width: 100%; max-width: 640px;
    max-height: 85vh; overflow-y: auto; padding: 20px 16px;
    padding-bottom: max(20px, env(safe-area-inset-bottom));
  }
  .settings-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 2px; margin: 0 auto 16px; }
  .settings-title { font-size: 17px; font-weight: 700; margin-bottom: 16px; }

  /* Complete screen */
  .complete-icon { font-size: 40px; margin-bottom: 8px; }
  .complete-title { font-size: 18px; font-weight: 700; color: var(--green); margin-bottom: 4px; }
  .complete-sub { font-size: 12px; color: var(--text3); }
  .complete-detail { font-size: 11px; color: var(--text3); font-family: monospace; margin-top: 6px; }

  /* Toast */
  .toast {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-80px);
    background: var(--red); color: #fff; padding: 8px 18px; border-radius: 8px;
    font-size: 12px; font-weight: 600; z-index: 200; transition: transform .3s; max-width: 90vw; text-align: center;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.ok { background: var(--green); }

  /* Responsive */
  @media (min-width: 640px) {
    .app { padding: 24px; padding-bottom: 100px; }
    .header h1 { font-size: 24px; }
    .settings-panel { border-radius: 20px; margin-bottom: 20px; }
    .file-list { max-height: 60vh; }
  }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
</style>
</head>
<body>
<div class="app" id="app">

  <!-- Reconnect banner (shown when connecting to active transfer) -->
  <div class="reconnect-banner" id="reconnect-banner" style="display:none">
    <span style="font-size:18px">ðŸ“±</span>
    <div>
      <div class="rb-text">Reconnected to active transfer</div>
      <div class="rb-sub">Transfer runs on the Pi â€” browser can be closed anytime</div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <div>
      <h1>Offloader</h1>
      <div class="header-sub" id="hostname">offloader.local:8080</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span class="xfer-label xfer-active pulse" id="xfer-badge" style="display:none">TRANSFERRING</span>
      <button class="btn-icon" onclick="openSettings()" title="Settings">&#x2699;</button>
    </div>
  </div>

  <!-- === IDLE VIEW === -->
  <div id="view-idle">
    <!-- Drive -->
    <div class="card">
      <div class="card-label">USB Drive</div>
      <div class="status-row">
        <span class="dot dot-r" id="drive-dot"></span>
        <span id="drive-status">No drive connected</span>
      </div>
      <div class="status-detail" id="drive-detail"></div>
    </div>

    <!-- NAS -->
    <div class="card">
      <div class="card-label">NAS Destination</div>
      <div class="status-row" style="margin-bottom:6px">
        <span class="dot dot-r" id="nas-dot"></span>
        <span id="nas-status">Disconnected</span>
      </div>
      <div class="path-display" id="nas-path">//100.109.23.38/archive</div>
      <div class="field">
        <label>Project Folder</label>
        <div style="display:flex;gap:6px">
          <input type="text" id="subfolder-input" placeholder="e.g. fishing" style="flex:1" />
          <button class="btn btn-sm btn-s" onclick="saveSubfolder()">Set</button>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-sm btn-p" id="nas-conn-btn" onclick="connectNAS()">Connect</button>
        <button class="btn btn-sm btn-d" id="nas-disc-btn" onclick="disconnectNAS()" style="display:none">Disconnect</button>
      </div>
    </div>

    <!-- Files -->
    <div class="card" id="files-card">
      <div class="file-header">
        <div class="card-label" style="margin:0">Files on Drive</div>
        <div style="display:flex;gap:6px;align-items:center">
          <span class="file-count" id="file-count"></span>
          <button class="btn btn-sm btn-s" id="select-all-btn" onclick="toggleSelectAll()">Select All</button>
        </div>
      </div>
      <div class="file-list" id="file-list">
        <div style="text-align:center;padding:40px 16px;color:var(--text3)">
          <div style="font-size:36px;margin-bottom:8px;opacity:.3">ðŸ’¾</div>
          <div style="font-size:13px">Connect a USB drive to see files</div>
        </div>
      </div>
    </div>
  </div>

  <!-- === TRANSFER VIEW === -->
  <div id="view-transfer" style="display:none">
    <div class="card">
      <div class="xfer-big">
        <div class="xfer-pct" id="t-pct">0%</div>
        <div class="xfer-sub" id="t-sub">0/0 files</div>
      </div>
      <div class="prog-bg"><div class="prog-fill" id="t-bar" style="width:0%"></div></div>
      <div class="prog-meta">
        <span class="speed" id="t-speed"></span>
        <span class="eta" id="t-eta"></span>
      </div>
    </div>

    <div class="card">
      <div class="card-label">Current File</div>
      <div id="t-curfile" style="font-size:12px;font-family:monospace;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></div>
      <div class="file-prog" style="margin-top:6px"><div class="file-prog-bar" id="t-fileprog" style="width:0%"></div></div>
    </div>

    <div class="card">
      <div class="card-label">Queue</div>
      <div id="t-queue" style="max-height:200px;overflow:auto"></div>
    </div>

    <div class="card">
      <div class="card-label">Destination</div>
      <div class="path-display" id="t-dest"></div>
    </div>

    <div style="text-align:center;padding:8px 0">
      <button class="btn btn-sm btn-d" onclick="cancelTransfer()">Cancel Transfer</button>
    </div>
  </div>

  <!-- === COMPLETE VIEW === -->
  <div id="view-complete" style="display:none">
    <div class="card" style="text-align:center;border-color:#22c55e30">
      <div class="complete-icon">âœ…</div>
      <div class="complete-title">Transfer Complete</div>
      <div class="complete-sub" id="c-summary"></div>
      <div class="complete-detail" id="c-detail"></div>
    </div>
    <div class="card">
      <div class="card-label">Saved to</div>
      <div class="path-display" id="c-dest"></div>
    </div>
    <div class="card">
      <div class="card-label">Transfer Log</div>
      <div id="c-log" style="max-height:200px;overflow:auto"></div>
    </div>
    <button class="btn btn-p" onclick="newTransfer()" style="width:100%;justify-content:center;margin-top:8px">New Transfer</button>
  </div>

</div>

<!-- Bottom bar (idle view only) -->
<div class="bottom-bar" id="bottom-bar">
  <div class="bottom-info">
    <span id="sel-info">No files selected</span>
    <small id="sel-size"></small>
  </div>
  <button class="btn btn-p" id="xfer-btn" onclick="startTransfer()" disabled>Transfer</button>
</div>

<!-- Settings -->
<div class="overlay" id="settings-overlay" onclick="if(event.target===this)closeSettings()">
  <div class="settings-panel" onclick="event.stopPropagation()">
    <div class="settings-handle"></div>
    <div class="settings-title">Settings</div>

    <div class="toggle-row">
      <span>Use Tailscale IP</span>
      <label class="toggle"><input type="checkbox" id="cfg-ts" checked><span class="sl"></span></label>
    </div>
    <div class="field">
      <label>Tailscale IP</label>
      <input type="text" id="cfg-ip" value="100.109.23.38" />
    </div>
    <div class="field">
      <label>Local IP</label>
      <input type="text" id="cfg-ip-local" value="192.168.88.20" />
    </div>
    <div class="field">
      <label>Share Name</label>
      <input type="text" id="cfg-share" value="archive" />
    </div>
    <div class="field">
      <label>SMB Version</label>
      <select id="cfg-smb-ver">
        <option value="3.0">3.0</option><option value="2.1">2.1</option>
        <option value="2.0">2.0</option><option value="1.0">1.0</option>
      </select>
    </div>
    <div class="field-row">
      <div class="field"><label>Username (blank=guest)</label><input type="text" id="cfg-user" placeholder="guest"/></div>
      <div class="field"><label>Password</label><input type="password" id="cfg-pass" placeholder="â€¢â€¢â€¢â€¢"/></div>
    </div>

    <div style="border-top:1px solid var(--border2);margin:12px 0;padding-top:12px">
      <div class="card-label" style="margin-bottom:8px">Discord Notifications</div>
      <div class="field">
        <label>Webhook URL</label>
        <input type="text" id="cfg-discord" placeholder="https://discord.com/api/webhooks/..." />
      </div>
      <div style="font-size:10px;color:var(--text3);margin-bottom:4px">
        Sends alerts at 25%, 50%, 75%, 100% with ETA and transfer stats
      </div>
    </div>

    <div class="toggle-row">
      <span>Verify checksums (slower)</span>
      <label class="toggle"><input type="checkbox" id="cfg-chk"><span class="sl"></span></label>
    </div>

    <div class="btn-row" style="margin-top:16px">
      <button class="btn btn-p" onclick="saveSettings()" style="flex:1">Save</button>
      <button class="btn btn-s" onclick="closeSettings()">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
<script>
let socket;
let files = [];
let selected = new Set();
let config = {};
let nasConn = false, driveConn = false;
let transferActive = false, transferFinished = false;

// ---- Init ----
function init() {
  socket = io({ transports: ['websocket', 'polling'] });

  socket.on('status', (d) => {
    config = d.config || {};
    driveConn = d.drive_mounted;
    nasConn = d.nas_mounted;
    files = d.files || [];
    applyConfig();
    updateDrive(d.drive);
    updateNAS();

    const t = d.transfer;
    if (t && t.active) {
      // Reconnected to active transfer!
      transferActive = true;
      showView('transfer');
      el('reconnect-banner').style.display = '';
      updateTransferUI(t);
    } else if (t && t.finished && t.finish_summary) {
      transferFinished = true;
      showComplete(t.finish_summary, t.completed_list || t.file_list || []);
    } else {
      showView('idle');
      renderFiles();
    }
  });

  socket.on('config_saved', (d) => { config = d.config; applyConfig(); updateNAS(); toast('Settings saved', 1); });
  socket.on('drive_connected', (d) => { driveConn = true; files = d.files || []; updateDrive(d.drive); renderFiles(); toast('Drive: ' + (d.drive?.model||'USB'), 1); });
  socket.on('drive_disconnected', () => { driveConn = false; files = []; selected.clear(); updateDrive(null); renderFiles(); updateSel(); toast('Drive disconnected'); });
  socket.on('drive_error', (d) => toast('Drive error: ' + d.error));
  socket.on('nas_connected', () => { nasConn = true; updateNAS(); toast('NAS connected', 1); });
  socket.on('nas_disconnected', () => { nasConn = false; updateNAS(); });
  socket.on('nas_error', (d) => { nasConn = false; updateNAS(); toast('NAS: ' + d.error); });
  socket.on('files_updated', (d) => { files = d.files || []; renderFiles(); });
  socket.on('error', (d) => toast(d.message));

  // Transfer events
  socket.on('transfer_started', (d) => {
    transferActive = true;
    el('reconnect-banner').style.display = 'none';
    showView('transfer');
  });

  socket.on('file_started', (d) => {
    el('t-curfile').textContent = d.name;
    el('t-fileprog').style.width = '0%';
    highlightQueue(d.index);
  });

  socket.on('file_progress', (d) => {
    el('t-pct').textContent = Math.round(d.overall_percent) + '%';
    el('t-bar').style.width = Math.round(d.overall_percent) + '%';
    el('t-fileprog').style.width = Math.round(d.file_percent) + '%';
    el('t-speed').textContent = '~' + d.speed_human;
    el('t-eta').textContent = 'ETA: ' + d.eta_human;
  });

  socket.on('file_verifying', (d) => { el('t-curfile').textContent = 'ðŸ” ' + d.name; });

  socket.on('file_complete', (d) => {
    el('t-pct').textContent = Math.round(d.overall_percent) + '%';
    el('t-bar').style.width = Math.round(d.overall_percent) + '%';
    markQueueDone(d.index);
  });

  socket.on('file_error', (d) => toast(d.name + ': ' + d.error));

  socket.on('transfer_complete', (d) => {
    transferActive = false;
    transferFinished = true;
    showComplete(d, []);
  });

  socket.on('transfer_cancelled', () => {
    transferActive = false;
    showView('idle');
    renderFiles();
    toast('Transfer cancelled');
  });
}

// ---- Helpers ----
function el(id) { return document.getElementById(id); }
function toast(msg, ok) {
  const t = el('toast');
  t.textContent = msg;
  t.className = 'toast show' + (ok ? ' ok' : '');
  setTimeout(() => t.className = 'toast', 3000);
}
function humanSize(b) {
  const u = ['B','KB','MB','GB','TB']; let i = 0;
  while (b >= 1024 && i < u.length-1) { b /= 1024; i++; }
  return b.toFixed(1) + ' ' + u[i];
}
function getExt(n) { const p = n.split('.'); return p.length > 1 ? p.pop().toUpperCase() : ''; }
function extStyle(ext) {
  const m = { BRAW:['#c4b5fd','#c4b5fd18'], MP4:['#67e8f9','#67e8f918'], MOV:['#67e8f9','#67e8f918'],
    WAV:['#fbbf24','#fbbf2418'], DNG:['#6ee7b7','#6ee7b718'], MXF:['#f472b6','#f472b618'] };
  return m[ext] || ['#94a3b8','#94a3b818'];
}

// ---- Views ----
function showView(v) {
  el('view-idle').style.display = v === 'idle' ? '' : 'none';
  el('view-transfer').style.display = v === 'transfer' ? '' : 'none';
  el('view-complete').style.display = v === 'complete' ? '' : 'none';
  el('bottom-bar').style.display = v === 'idle' ? '' : 'none';
  el('xfer-badge').style.display = v === 'transfer' ? '' : 'none';
}

// ---- Config ----
function applyConfig() {
  el('cfg-ip').value = config.nas_ip || '';
  el('cfg-ip-local').value = config.nas_ip_local || '';
  el('cfg-share').value = config.share_name || '';
  el('subfolder-input').value = config.subfolder || '';
  el('cfg-ts').checked = config.use_tailscale !== false;
  el('cfg-smb-ver').value = config.smb_version || '3.0';
  el('cfg-user').value = config.smb_username || '';
  el('cfg-chk').checked = !!config.verify_checksums;
  el('cfg-discord').value = config.discord_webhook || '';
  updatePath();
}
function updatePath() {
  const ip = config.use_tailscale !== false ? (config.nas_ip||'100.109.23.38') : (config.nas_ip_local||'192.168.88.20');
  const share = config.share_name || 'archive';
  const sub = el('subfolder-input').value;
  el('nas-path').textContent = `//${ip}/${share}${sub ? '/'+sub : ''}`;
}

// ---- Drive / NAS ----
function updateDrive(d) {
  if (driveConn && d) {
    el('drive-dot').className = 'dot dot-g';
    el('drive-status').textContent = d.model || 'USB Drive';
    el('drive-detail').textContent = `${d.device} â€¢ ${d.size} â€¢ ${d.fstype||'auto'}`;
  } else {
    el('drive-dot').className = 'dot dot-r';
    el('drive-status').textContent = 'No drive connected';
    el('drive-detail').textContent = '';
  }
}
function updateNAS() {
  el('nas-dot').className = nasConn ? 'dot dot-g' : 'dot dot-r';
  el('nas-status').textContent = nasConn ? 'Connected' : 'Disconnected';
  el('nas-conn-btn').style.display = nasConn ? 'none' : '';
  el('nas-disc-btn').style.display = nasConn ? '' : 'none';
  updatePath();
}

// ---- Files ----
function renderFiles() {
  const list = el('file-list');
  if (!driveConn || files.length === 0) {
    list.innerHTML = `<div style="text-align:center;padding:40px 16px;color:var(--text3)"><div style="font-size:36px;margin-bottom:8px;opacity:.3">ðŸ’¾</div><div style="font-size:13px">${driveConn?'No files on drive':'Connect a USB drive'}</div></div>`;
    el('file-count').textContent = '';
    return;
  }
  el('file-count').textContent = files.length + ' files';
  list.innerHTML = files.map((f, i) => {
    const ext = getExt(f.name);
    const [fg, bg] = extStyle(ext);
    const on = selected.has(f.name);
    return `<div class="file-item" onclick="toggleFile('${esc(f.name)}')">
      <div class="chk ${on?'on':''}">âœ“</div>
      <div class="file-name">${escH(f.name)}</div>
      ${ext?`<span class="file-ext" style="color:${fg};background:${bg}">${ext}</span>`:''}
      <span class="file-size">${f.size_human}</span>
    </div>`;
  }).join('');
  updateSel();
}
function esc(s) { return s.replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
function escH(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
function toggleFile(n) { if (transferActive) return; selected.has(n)?selected.delete(n):selected.add(n); renderFiles(); }
function toggleSelectAll() { if (transferActive) return; selected.size===files.length?selected.clear():files.forEach(f=>selected.add(f.name)); renderFiles(); }
function updateSel() {
  const c = selected.size;
  const bytes = files.filter(f=>selected.has(f.name)).reduce((a,f)=>a+f.size,0);
  el('sel-info').textContent = c>0 ? `${c} file${c>1?'s':''}` : 'No files selected';
  el('sel-size').textContent = c>0 ? humanSize(bytes) : '';
  el('xfer-btn').disabled = c===0 || !nasConn || transferActive;
  el('select-all-btn').textContent = selected.size===files.length && files.length>0 ? 'Deselect' : 'Select All';
}

// ---- Transfer UI (reconnect-aware) ----
function updateTransferUI(t) {
  const pct = Math.round(t.overall_percent);
  el('t-pct').textContent = pct + '%';
  el('t-bar').style.width = pct + '%';
  el('t-sub').textContent = `${t.completed_files}/${t.total_files} files â€¢ ${humanSize(t.bytes_done)} / ${humanSize(t.total_bytes)}`;
  el('t-curfile').textContent = t.current_file;
  el('t-fileprog').style.width = Math.round(t.current_file_percent) + '%';
  el('t-speed').textContent = t.speed_human ? '~'+t.speed_human : '';
  el('t-eta').textContent = t.eta_human ? 'ETA: '+t.eta_human : '';
  el('t-dest').textContent = t.destination;
  renderQueue(t.file_list, t.completed_list, t.current_file_index);
}

function renderQueue(fileList, completedList, curIdx) {
  const q = el('t-queue');
  const done = new Set(completedList || []);
  q.innerHTML = (fileList||[]).map((n, i) => {
    const isDone = done.has(n) || i < curIdx;
    const isCur = i === curIdx;
    const cls = isDone ? 'queue-done' : isCur ? 'queue-cur' : 'queue-pend';
    const icon = isDone ? 'âœ“' : isCur ? 'â–¶' : 'Â·';
    return `<div class="queue-item ${cls}"><span style="width:14px;text-align:center;font-size:9px">${icon}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escH(n)}</span></div>`;
  }).join('');
}

function highlightQueue(idx) {
  const items = el('t-queue').querySelectorAll('.queue-item');
  items.forEach((el, i) => {
    if (i < idx) el.className = 'queue-item queue-done';
    else if (i === idx) el.className = 'queue-item queue-cur';
    else el.className = 'queue-item queue-pend';
  });
}

function markQueueDone(idx) {
  const items = el('t-queue').querySelectorAll('.queue-item');
  if (items[idx]) items[idx].className = 'queue-item queue-done';
}

// ---- Complete ----
function showComplete(summary, logFiles) {
  showView('complete');
  el('c-summary').textContent = `${summary.total_files} files â€¢ ${summary.total_size_human} â€¢ ${(summary.errors||[]).length} errors`;
  el('c-detail').textContent = `Duration: ${summary.duration} â€¢ Avg: ${summary.avg_speed}`;
  el('c-dest').textContent = summary.destination;
  const logList = logFiles.length > 0 ? logFiles : (summary.file_list || []);
  el('c-log').innerHTML = logList.map(n =>
    `<div class="queue-item queue-done"><span style="color:var(--green);font-size:9px">âœ“</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escH(n)}</span></div>`
  ).join('');
}

function newTransfer() {
  socket.emit('clear_finished');
  transferFinished = false;
  selected.clear();
  showView('idle');
  renderFiles();
}

// ---- Actions ----
function connectNAS() { el('nas-conn-btn').disabled=true; el('nas-conn-btn').textContent='Connecting...'; socket.emit('connect_nas'); setTimeout(()=>{el('nas-conn-btn').disabled=false;el('nas-conn-btn').textContent='Connect';},5000); }
function disconnectNAS() { socket.emit('disconnect_nas'); }
function saveSubfolder() { config.subfolder = el('subfolder-input').value.replace(/^\/+|\/+$/g,''); socket.emit('save_config',{subfolder:config.subfolder}); updatePath(); }
function startTransfer() { if (selected.size===0||!nasConn) return; socket.emit('start_transfer',{files:[...selected]}); }
function cancelTransfer() { socket.emit('cancel_transfer'); }

// ---- Settings ----
function openSettings() { el('settings-overlay').classList.add('open'); }
function closeSettings() { el('settings-overlay').classList.remove('open'); }
function saveSettings() {
  socket.emit('save_config', {
    nas_ip: el('cfg-ip').value.trim(), nas_ip_local: el('cfg-ip-local').value.trim(),
    share_name: el('cfg-share').value.trim(), smb_username: el('cfg-user').value.trim(),
    smb_password: el('cfg-pass').value, smb_version: el('cfg-smb-ver').value,
    use_tailscale: el('cfg-ts').checked, verify_checksums: el('cfg-chk').checked,
    discord_webhook: el('cfg-discord').value.trim(),
  });
  closeSettings();
}

el('subfolder-input').addEventListener('input', updatePath);
init();
</script>
</body>
</html>
